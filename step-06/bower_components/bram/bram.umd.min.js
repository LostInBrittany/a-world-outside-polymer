(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(Q,R){return Array.isArray(Q)&&!isNaN(+R)}function d(Q){return Array.isArray(Q)||'object'==typeof Q}function e(Q,R){var S=new Proxy(Q,{get:function(T,U){return C.observe(S,U),T[U]},set:function(T,U,V){var W=T[U];// If the value hasn't changed, nothing else to do
return!(!G(V)&&d(V)&&(V=F(V)),T[U]=V,V!==W)||(c(T,U)?R({prop:E,index:+U,type:'set'},V):R({prop:U,type:'set'},V),!0)},deleteProperty:function(T,U){return c(T,U)&&R({prop:E,index:+U,type:'delete'}),!0}});return S}function f(Q){return Q?Object.keys(Q).reduce(function(R,S){var T=Q[S];return R[S]=Array.isArray(T)||'object'==typeof T?F(T):T,R},Q):Q}function g(Q,R){this.model=Q,this.parent=R}function h(Q,R,S){var V=Object.keys(R);if(0!==V.length){function ca(ea){if(X++,W===X){var fa=R[W];fa(ea,S,Q),W=+V.shift()}return!W}function da(ea){var fa,ga=B.call(ea.attributes||[]);if(A.call(ga,function(){if(fa=ca(ea),fa)return!0}),fa)return!1;for(var ia,ha=ea.firstChild;ha&&(ia=ha.nextSibling,fa=ca(ha),!fa)&&(fa=!da(ha),!fa);)ha=ia;return!fa}var W=+V.shift(),X=0;da(Q.tree)}}function j(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}function k(Q){for(var X,R=0,S=Q.length,T=new j,U=!1,V='',W=0;R<S;){if(V=X,X=Q[R],!U){if('{'===X){'{'==V&&(T.hasBinding=!0,W=T.raw.length,null!=T.values[W]&&W++,T.values[W]='',U=!0),R++;continue}else'{'==V&&(T.raw+=V);T.raw+=X}else{if('}'===X){'}'==V&&(U=!1),R++;continue}T.values[W]+=X}R++}return T.includesNonBindings=0<T.raw.length,T}function m(Q,R,S,T){var U=R.compute(Q),V=function(){T(U())};R.props().forEach(function(W){var X=Q.readInTransaction(W);if(X.model,!1!==X.bindable){var Y=new Map;X.reads.forEach(function(Z){var $=Z[0],aa=Z[1];if(Y.has($)){var ba=Y.get($);if(ba.has(aa))return;ba.set(aa,!0)}else{var ba=new Map;ba.set(aa,!0),Y.set($,ba)}S.on($,aa,V)})}}),V()}function n(Q,R,S){var T={};switch(Q.nodeType){// Element
case 1:var U;if('TEMPLATE'===Q.nodeName&&(U=p(Q))){var V=k(Q.getAttribute(U));V.hasBinding&&(V.throwIfMultiple(),T[U]=!0,S[R.id]=function(X,Y,Z){'each'===U?J.each(X,Y,V,Z):m(Y,V,Z,J[U](X,Y,Z))})}break;// TextNode
case 3:var V=k(Q.nodeValue);V.hasBinding&&(S[R.id]=function(X,Y,Z){m(Y,V,Z,J.text(X))});}z.call(Q.attributes||[],function(X){if(R.id++,!T[X.name]){var Y=X.name,Z=q(Y),$=k(X.value);if($.hasBinding)S[R.id]=function(ea,fa,ga){return Z?(ea.removeAttribute(Y),void m(fa,$,ga,J.prop(ea,Z))):void m(fa,$,ga,J.attr(ea,Y))};else if(Z)S[R.id]=function(ea){ea.removeAttribute(Y),J.prop(ea,Z)(X.value)};else if('on-'===Y.substr(0,3)){var aa=Y.substr(3);S[R.id]=function(ea,fa,ga){ea.removeAttribute(Y),J.event(ea,aa,fa,$,ga)}}}});var W=Q.childNodes;return z.call(W,function(X){R.id++,n(X,R,S)}),S}function p(Q){var R;for(var S=0,T=K.length;S<T;S++)if(R=K[S],Q.getAttribute(R))return R}function q(Q){return Q&&':'===Q[0]&&Q.substr(1)}function r(Q){return class extends Q{constructor(){super();var R=this.constructor;let S=R.template;S&&(this._hydrate=N(S)),this._hasRendered=!1,this.model={};let T=R.events;T&&!R._hasSetupEvents&&s(R);let U=!R._hasInstalledProps&&R.observedProperties;U&&(R._hasInstalledProps=!0,u(R,U,R.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){G(this.model)||(this.model=F(this.model));var R=new g(this).add(this.model);this._link=this._hydrate(R);var S=this._link.tree,T=this.constructor.renderMode;'light'===T?(this.innerHTML='',this.appendChild(S)):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(S)),this._hasRendered=!0}else this._hasRendered&&this._link.attach();this.childrenConnectedCallback&&(this._disconnectChildMO=v(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(R,S,T){var U=this.constructor._syncedAttrs,V=U&&U[R];V&&this[R]!==T&&(this[R]=T)}}}function s(Q){Q._hasSetupEvents=!0,Q.events.forEach(function(R){Object.defineProperty(Q.prototype,'on'+R,{get:function(){return this['_on'+R]},set:function(S){var T='_on'+R,U=this[T];U&&this.removeEventListener(R,U),this[T]=S,this.addEventListener(R,S)}})})}function u(Q,R,S=[]){Q._syncedAttrs={};var T=Q.prototype;R.forEach(function(U){var V=Object.getOwnPropertyDescriptor(T,U);if(!V){var W=-1!==S.indexOf(U);W&&(Q._syncedAttrs[U]=!0),Object.defineProperty(T,U,{get:function(){return this.model[U]},set:function(X){if(this.model[U]=X,W){var Y=this.getAttribute(U);'boolean'==typeof X?X&&''!==Y?this.setAttribute(U,''):''===Y&&!X&&this.removeAttribute(U):Y!==X&&this.setAttribute(U,X)}}})}})}function v(Q){var R=!1,S=function(){R||Q.childrenConnectedCallback()};if(!P)return void y(S);var T=new MutationObserver(S);return T.observe(Q,{childList:!0}),Q.childNodes.length&&y(S),function(){R=!0,T.disconnect()}}var w='function'==typeof Symbol?Symbol:function(Q){return'@@-'+Q},x=Object.values||function(Q){return Object.keys(Q).reduce(function(R,S){return R.push(Q[S]),R},[])},y='function'==typeof Promise?Q=>Promise.resolve().then(Q):Q=>setTimeout(()=>Q(),0),z=Array.prototype.forEach,A=Array.prototype.some,B=Array.prototype.slice;class C{static add(Q){this.current=Q,this.stack.push(Q)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(Q,R){this.current&&this.current.stack.push([Q,R])}constructor(){this.stack=[]}start(){C.add(this)}stop(){return C.remove(),this.stack}}C.stack=[];var D=w('bram-events'),E=w('bram-array-change'),F=function(Q,R){return G(Q)?Q:(Q=f(Q,R)||{},Object.defineProperty(Q,D,{value:{},enumerable:!1}),e(Q,function(S,T){var U=Q[D][S.prop];U&&U.forEach(function(V){V(S,T)})}))},G=function(Q){return Q&&!!Q[D]},H=function(Q,R,S){var T=Q[D];if(T){var U=T[R];U||(U=T[R]=[]),U.push(S)}},I=function(Q,R,S){var T=Q[D];if(T){var U=T[R];if(U){var V=U.indexOf(S);-1===V||(U.splice(V,1),!U.length&&delete T[R])}}};g.prototype.read=function(Q){return this._read(Q)||{model:this.model,value:void 0}},g.prototype.readInTransaction=function(Q){var R=new C;R.start();var S=this.read(Q);return S.reads=R.stop(),S},g.prototype._read=function(Q){var R=this.model,S=R[Q];if(null==S){// Handle dotted bindings like "user.name"
var T=Q.split('.');if(1<T.length)do S=R[T.shift()],T.length&&(R=S);while(T.length&&S)}return null==S?this.parent?this.parent.read(Q):void 0:{model:R,value:S}},g.prototype.add=function(Q){var R;return R=G(Q)?Q:Array.isArray(Q)||'object'==typeof Q?F(Q):Q,new g(R,this)},j.prototype.getValue=function(Q){var R=this.props()[0];return Q.read(R).value},j.prototype.getStringValue=function(Q){for(var T,U,R=Object.keys(this.values).sort(function(V,W){return+V>+W?1:-1}),S=this.raw;R.length;)T=R.pop(),U=Q.read(this.values[T]).value,null!=U&&(S=S.substr(0,T)+U+S.substr(T));return S},j.prototype.compute=function(Q){var R=this.includesNonBindings||1<this.count();return R?this.getStringValue.bind(this,Q):this.getValue.bind(this,Q)},j.prototype.props=function(){return x(this.values)},j.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},j.prototype.throwIfMultiple=function(Q){if(1<this.count())throw Q=Q||'Only a single binding is allowed in this context.',new Error(Q)};var J={attr:function(Q,R){return function(S){Q.setAttribute(R,S)}},text:function(Q){return function(R){Q.nodeValue=R}},prop:function(Q,R){return function(S){Q[R]=S}},event:function(Q,R,S,T,U){var V=T.raw;U.bind(Q,R,function(W){var X=S.read(V);X.value.call(X.model,W)})},each:function(Q,R,S,T){var U=N(Q),V=S.props()[0],W=R.read(V),X=document.createTextNode('');Q.parentNode.replaceChild(X,Q);var Y=function($){var aa=new Map,ba=new Map,ca=function(fa,ga){var ha=R.add(fa).add({item:fa,index:ga}),ia=U(ha);T.add(ia);var ja=ia.tree,ka={item:fa,link:ia,nodes:B.call(ja.childNodes),scope:ha,index:ga};aa.set(fa,ka),ba.set(ga,ka);var la=ba.get(ga+1),ma=X.parentNode;if(la){var na=la.nodes[0];ma.insertBefore(ja,na)}else ma.appendChild(ja)},da=function(fa){var ga=ba.get(fa);ga&&(ga.nodes.forEach(function(ha){ha.parentNode.removeChild(ha)}),T.remove(ga.link),aa.delete(ga.item),ba.delete(fa))};$.forEach(ca);var ea=function(fa,ga){if('delete'===fa.type)return void da(fa.index);var ha=aa.get(ga);if(ha){var ia=ha.index,ja=ia!==fa.index;if(ja){ha.scope.model.index=ha.index=fa.index;var ka=ba.get(fa.index);ka?ba.set(ia,ka):ba.delete(ia),ba.set(fa.index,ha);var la=ba.get(fa.index+1);la&&(la=la.nodes[0]);for(var ma=ha.nodes.length-1;0<=ma;)X.parentNode.insertBefore(ha.nodes[ma],la),ma--}}else da(fa.index),ca(ga,fa.index)};return T.on($,E,ea),function(){for(var fa=0,ga=$.length;fa<ga;fa++)da(fa);T.off($,E,ea),aa=null,ba=null}},Z=Y(W.value);T.on(W.model,V,function($,aa){Z(),Z=Y(aa)})},if:function(Q,R,S){var T=N(Q),U=!1,V={},W=document.createTextNode('');return Q.parentNode.replaceChild(W,Q),function(X){if(!!U){var aa=W.parentNode,ba=W.nextSibling;X?V.children.forEach(function(ca){aa.insertBefore(ca,ba)}):V.children.forEach(function(ca){aa.removeChild(ca)})}else if(X){var Y=R.add(X),Z=T(Y);S.add(Z);var $=Z.tree;V.children=B.call($.childNodes),V.scope=Y,W.parentNode.insertBefore($,W.nextSibling),U=!0}}}},K=['if','each'];class L{constructor(){this.map=new Map}set(Q,R,S){let T=this.map.get(Q);T||(T=new Map,this.map.set(Q,T)),T.set(R,S)}delete(Q,R){let S=this.map.get(Q);S&&S.delete(R)}}class M{constructor(Q){this.tree=Q,this.models=new L,this.elements=new L,this.children=[]}loop(Q,R){for(let[S,T]of Q)R(S,T[0],T[1])}on(Q,R,S){this.models.set(Q,R,S),H(Q,R,S)}off(Q,R,S){this.models.delete(Q,R),I(Q,R,S)}bind(Q,R,S){this.elements.set(Q,R,S),Q.addEventListener(R,S)}attach(){this.loop(this.models,H),this.children.forEach(function(Q){Q.attach()})}detach(){this.loop(this.models,I),this.children.forEach(function(Q){Q.detach()})}add(Q){this.children.push(Q)}remove(Q){var R=this.children.indexOf(Q);this.children.splice(R,1)}}var N=function(Q){Q=Q instanceof HTMLTemplateElement?Q:document.querySelector(Q);var R=n(Q.content,{id:0},{});return function(S){S instanceof g||(S=new g(S));var T=document.importNode(Q.content,!0),U=new M(T);return h(U,R,S),U}},O=r(HTMLElement);r.Element=O,r.model=F,r.on=H,r.off=I,r.template=N;var P='function'==typeof MutationObserver;return r});

